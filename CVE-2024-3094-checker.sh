#!/bin/bash

# Detect package manager
if type -P apt-get >/dev/null 2>&1; then
    PKG_MANAGER="apt-get"
    version=$(dpkg -l | grep "xz-utils" | awk '{print $3}' | sed 's/-.*//')
elif type -P yum >/dev/null 2>&1; then
    PKG_MANAGER="yum"
    version=$(yum list installed | grep "xz" | awk '{print $2}' | sed 's/-.*1//g')
elif type -P zypper >/dev/null 2>&1; then
    PKG_MANAGER="zypper"
    version=$(zypper info xz | awk '/Version/' | awk '{print $3}' | sed 's/-.*//')
elif type -P pacman >/dev/null 2>&1; then
    PKG_MANAGER="pacman"
    version=$(pacman -Qi xz | awk '/Version/' | awk '{print $3}' | sed 's/-.*//')
else
    echo "Unsupported package manager. Exiting."
    exit 1
fi


# Check if vulnerable version is installed
if [[ "$version" == *"5.6.0"* || "$version" == *"5.6.1"* ]]; then
    echo "Vulnerable version of xz-utils found: $version"
    read -p "Do you want to attempt installing the stable uncompromised xz-utils 5.4.6 version from source? (You need to have wget, tar, make, sudo) (y/n): " choice
    if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
        echo "Downloading xz-utils 5.4.6 from source..."
        wget https://github.com/tukaani-project/xz/releases/download/v5.4.6/xz-5.4.6.tar.xz
        tar -zxvf xz-5.4.6.tar.gz
        cd xz-5.4.6
        echo "Configuring xz-utils..."
        ./configure
        echo "Compiling xz-utils..."
        make
        echo "Installing xz-utils..."
        sudo make install
        echo "xz-utils 5.4.6 installed successfully."
    else
        echo "You chose not to install the package automatically. Install manually if needed. Exiting."
    fi
else
    echo "You are using version $version of xz-utils which is not vulnerable. Exiting..."
fi
